import sys
import os

from setuptools import setup, Extension
from setuptools.command.build_ext import build_ext as _build_ext


def is_cmake_true(value: str) -> bool:
    """Check if a string value is a CMake true value."""
    return value.upper() in ("1", "ON", "TRUE", "YES", "Y")


def get_py_limited_api_arg() -> dict:
    """Get py_limited_api argument if enabled by CMake."""
    if is_cmake_true("@SimpleITK_PYTHON_USE_LIMITED_API@"):
        return {"py_limited_api": True}
    return {}


class build_ext(_build_ext):
    """Override standard command class to build an extension, to
    simply copy an existing compiled library into the packaging
    directory structure.
    """

    def build_extension(self, ext):
        """Copy pre-compiled library into package structure."""
        from distutils.errors import DistutilsSetupError

        sources = ext.sources
        if sources is None or not len(sources) == 1:
            raise DistutilsSetupError("Expected only one compiled library.")

        ext_file = self.get_ext_fullpath(ext.name)
        abs_sources = list(map(os.path.abspath, sources))

        self.copy_file(abs_sources[0], ext_file)


# Minimal setup.py - all metadata is in pyproject.toml
setup(
    ext_modules=[
        Extension(
            'SimpleITK._SimpleITK',
            [r'SimpleITK/@SimpleITK_BINARY_MODULE@'],
            **get_py_limited_api_arg()
        )
    ],
    cmdclass={'build_ext': build_ext}
)
